<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Real-time Username Chat</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width:700px; margin:2rem auto; }
    #messages { border:1px solid #ddd; min-height:240px; padding:10px; margin-bottom:10px; overflow:auto; }
    .msg { margin:6px 0; }
    .meta { font-size:0.85em; color:#666; }
    .you { font-weight:600; }
    #username { width:200px; }
    #text { width:70%; }
  </style>
</head>
<body>
  <h1>Real-time Username Chat</h1>
  <label>Username: <input id="username" placeholder="Pick a name" /></label>
  <div id="messages" aria-live="polite"></div>
  <input id="text" placeholder="Type a message..." />
  <button id="send">Send</button>

  <!-- socket.io client from server -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const usernameInput = document.getElementById('username');
    const messagesDiv = document.getElementById('messages');
    const textInput = document.getElementById('text');
    const sendBtn = document.getElementById('send');

    usernameInput.value = localStorage.getItem('chat-username') || '';

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    function appendMessage({username, message, time}) {
      const el = document.createElement('div');
      el.className = 'msg';
      el.innerHTML = '<span class="meta">' + new Date(time).toLocaleTimeString() + ' </span>' +
                     '<span class="you">' + escapeHtml(username) + ':</span> ' +
                     escapeHtml(message);
      messagesDiv.appendChild(el);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // set username on server whenever user changes it
    usernameInput.addEventListener('change', () => {
      const name = usernameInput.value.trim() || 'Anonymous';
      localStorage.setItem('chat-username', name);
      socket.emit('set username', name);
    });

    // set initial username
    if (usernameInput.value) socket.emit('set username', usernameInput.value);

    sendBtn.addEventListener('click', sendMessage);
    textInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    function sendMessage() {
      const msg = textInput.value.trim();
      if (!msg) return;
      socket.emit('chat message', msg);
      textInput.value = '';
    }

    socket.on('chat message', (payload) => {
      appendMessage(payload);
    });
  </script>
</body>
</html>
